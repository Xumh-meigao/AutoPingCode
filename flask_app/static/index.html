<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£ä¹¦é¡¹ç›®ä¸PingCodeé›†æˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 24px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* å°†åŸæ¥çš„ input[type="text"] ä¿®æ”¹ä¸ºåŒ…å«å¯†ç è¾“å…¥æ¡† */
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        /* åŒæ—¶æ›´æ–°ç„¦ç‚¹çŠ¶æ€çš„é€‰æ‹©å™¨ */
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }

        .result-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .task-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: #e9ecef;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            text-align: center;
            margin-top: 5px;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .card-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>é£ä¹¦é¡¹ç›®ä¸PingCodeé›†æˆå·¥å…·</h1>
        <p class="subtitle">è‡ªåŠ¨åŒ–åŒæ­¥Bugä¿¡æ¯å’ŒSprintæ•°æ®</p>
    </header>

    <div class="card-container">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ›</div>
                <h2 class="card-title">æ›´æ–°Bugä¿¡æ¯</h2>
            </div>
            <p>ä»PingCodeè·å–æœ€æ–°çš„Bugæ•°æ®å¹¶æ›´æ–°åˆ°é£ä¹¦é¡¹ç›®ä¸­</p>

            <button id="updateBugBtn" class="btn">å¼‚æ­¥æ›´æ–°æ‰€æœ‰Bugä¿¡æ¯</button>

            <div id="bugLoading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æäº¤ä»»åŠ¡ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="bugTaskStatus" class="task-status">
                <div>ä»»åŠ¡ID: <span id="bugTaskId"></span></div>
                <div>çŠ¶æ€: <span id="bugTaskStatusText">ç­‰å¾…ä¸­</span></div>
                <div class="progress-bar">
                    <div id="bugProgressFill" class="progress-fill"></div>
                </div>
                <div id="bugProgressText" class="progress-text">0%</div>
            </div>

            <div id="bugResult" class="result-section"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ“ˆ</div>
                <h2 class="card-title">æ›´æ–°Sprint Bugs</h2>
            </div>
            <p>æ›´æ–°æŒ‡å®šSprintä¸‹çš„æ‰€æœ‰Bugåˆ—è¡¨</p>

            <div class="form-group">
                <label for="sprintName">Sprintåç§°:</label>
                <input type="text" id="sprintName" placeholder="è¯·è¾“å…¥Sprintåç§°ï¼Œä¾‹å¦‚ï¼šSprint 1">
            </div>

            <button id="updateSprintBtn" class="btn">å¼‚æ­¥æ›´æ–°Sprint Bugs</button>

            <div id="sprintLoading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æäº¤ä»»åŠ¡ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="sprintTaskStatus" class="task-status">
                <div>ä»»åŠ¡ID: <span id="sprintTaskId"></span></div>
                <div>Sprint: <span id="sprintTaskName"></span></div>
                <div>çŠ¶æ€: <span id="sprintTaskStatusText">ç­‰å¾…ä¸­</span></div>
                <div class="progress-bar">
                    <div id="sprintProgressFill" class="progress-fill"></div>
                </div>
                <div id="sprintProgressText" class="progress-text">0%</div>
            </div>

            <div id="sprintResult" class="result-section"></div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="card-icon">ğŸ’¾</div>
                <h2 class="card-title">è·å–NAS SMARTä¿¡æ¯</h2>
            </div>
            <p>è·å–æŒ‡å®šNASè®¾å¤‡çš„ç£ç›˜SMARTä¿¡æ¯å¹¶å­˜å‚¨åˆ°æ•°æ®åº“</p>

            <div class="form-group">
                <label for="nasIp">NAS IPåœ°å€:</label>
                <input type="text" id="nasIp" placeholder="è¯·è¾“å…¥NASè®¾å¤‡IPåœ°å€">
            </div>

            <div class="form-group">
                <label for="nasUser">ç”¨æˆ·å:</label>
                <input type="text" id="nasUser" placeholder="è¯·è¾“å…¥ç™»å½•ç”¨æˆ·å">
            </div>

            <div class="form-group">
                <label for="nasPassword">å¯†ç  (å¯é€‰):</label>
                <input type="password" id="nasPassword" placeholder="è¯·è¾“å…¥ç™»å½•å¯†ç ">
            </div>

            <button id="getSmartBtn" class="btn">è·å–SMARTä¿¡æ¯</button>

            <!-- New navigation button -->
            <button id="viewSmartBtn" class="btn"
                    style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);">
                æŸ¥çœ‹SMARTæ•°æ®æŠ¥è¡¨
            </button>

            <div id="smartLoading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨è·å–SMARTä¿¡æ¯ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div id="smartResult" class="result-section"></div>
        </div>

    </div>

    <footer>
        <p>é£ä¹¦é¡¹ç›®ä¸PingCodeé›†æˆå·¥å…· Â© 2025</p>
    </footer>
</div>

<script>
    // APIåŸºç¡€URLé…ç½®
    const API_BASE_URL = '/api/v1/feishu_pingcode';

    // ä»»åŠ¡è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    const POLLING_INTERVAL = 3000;

    // å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨
    class AsyncTaskManager {
        constructor() {
            this.activeTasks = new Map();
        }

        // æäº¤å¼‚æ­¥ä»»åŠ¡
        async submitTask(apiEndpoint, requestData = null) {
            const response = requestData
                ? await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                : await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

            return await response.json();
        }

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        pollTaskStatus(taskId, onStatusUpdate, onResult) {
            const poll = async () => {
                try {
                    // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
                    const statusResponse = await fetch(`${API_BASE_URL}/tasks/${taskId}`);
                    const statusResult = await statusResponse.json();

                    if (statusResult.code === 0) {
                        // è·å–åŒ…å«è¿›åº¦ä¿¡æ¯çš„çŠ¶æ€æ•°æ®
                        const statusData = statusResult.data;
                        onStatusUpdate(statusData);

                        if (statusData.status === 'completed' || statusData.status === 'failed') {
                            // è·å–ä»»åŠ¡ç»“æœ
                            const resultResponse = await fetch(`${API_BASE_URL}/tasks/${taskId}/result`);
                            const result = await resultResponse.json();
                            onResult(result);
                            return;
                        }
                    } else {
                        onResult(statusResult);
                        return;
                    }

                    // ç»§ç»­è½®è¯¢
                    setTimeout(poll, POLLING_INTERVAL);
                } catch (error) {
                    onResult({
                        code: 2,
                        message: "è½®è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥",
                        data: {
                            error: error.message
                        }
                    });
                }
            };

            // å¼€å§‹è½®è¯¢
            poll();
        }
    }

    // åˆ›å»ºä»»åŠ¡ç®¡ç†å™¨å®ä¾‹
    const taskManager = new AsyncTaskManager();

    // æ›´æ–°Bugä¿¡æ¯æŒ‰é’®äº‹ä»¶
    document.getElementById('updateBugBtn').addEventListener('click', async function() {
        const btn = this;
        const loadingEl = document.getElementById('bugLoading');
        const taskStatusEl = document.getElementById('bugTaskStatus');
        const resultEl = document.getElementById('bugResult');
        const taskIdEl = document.getElementById('bugTaskId');
        const statusTextEl = document.getElementById('bugTaskStatusText');
        const progressFillEl = document.getElementById('bugProgressFill');
        const progressTextEl = document.getElementById('bugProgressText');

        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.disabled = true;
        loadingEl.style.display = 'block';
        taskStatusEl.style.display = 'none';
        resultEl.style.display = 'none';

        try {
            // æäº¤å¼‚æ­¥ä»»åŠ¡
            const response = await taskManager.submitTask(`${API_BASE_URL}/bugs/update/async`);

            if (response.code === 0) {
                const taskId = response.data.task_id;

                // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
                taskIdEl.textContent = taskId;
                statusTextEl.textContent = 'å·²æäº¤';
                progressFillEl.style.width = '0%';
                progressTextEl.textContent = '0%';
                taskStatusEl.style.display = 'block';
                loadingEl.style.display = 'none';

                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                taskManager.pollTaskStatus(
                    taskId,
                    (statusData) => {
                        // ä½¿ç”¨å®é™…è¿›åº¦å€¼æ›´æ–°è¿›åº¦æ¡
                        const progress = statusData.progress || 0;
                        progressFillEl.style.width = `${progress}%`;
                        progressTextEl.textContent = `${progress}%`;

                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        statusTextEl.textContent = statusData.status === 'completed' ? 'å·²å®Œæˆ' :
                                                 statusData.status === 'failed' ? 'å¤±è´¥' :
                                                 statusData.status === 'running' ? `è¿è¡Œä¸­ (${progress}%)` : 'å¤„ç†ä¸­';
                    },
                    (result) => {
                        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                        if (result.code === 0) {
                            showResult(resultEl, 'success', `
                                <strong>æˆåŠŸæ›´æ–°Bugä¿¡æ¯!</strong><br>
                                å¤„ç†æ€»æ•°: ${result.data.count || 0}<br>
                                æˆåŠŸæ•°é‡: ${result.data.success?.length || 0}<br>
                                å¤±è´¥æ•°é‡: ${result.data.error?.length || 0}
                            `);
                        } else {
                            showResult(resultEl, 'error', `<strong>æ›´æ–°å¤±è´¥:</strong> ${result.message}`);
                        }

                        // æ¢å¤æŒ‰é’®
                        btn.disabled = false;
                    }
                );
            } else {
                showResult(resultEl, 'error', `<strong>ä»»åŠ¡æäº¤å¤±è´¥:</strong> ${response.message}`);
                btn.disabled = false;
                loadingEl.style.display = 'none';
            }
        } catch (error) {
            showResult(resultEl, 'error', `<strong>è¯·æ±‚å¤±è´¥:</strong> ${error.message}`);
            btn.disabled = false;
            loadingEl.style.display = 'none';
        }
    });

    // æ›´æ–°Sprint BugsæŒ‰é’®äº‹ä»¶
    document.getElementById('updateSprintBtn').addEventListener('click', async function() {
        const btn = this;
        const sprintName = document.getElementById('sprintName').value.trim();
        const loadingEl = document.getElementById('sprintLoading');
        const taskStatusEl = document.getElementById('sprintTaskStatus');
        const resultEl = document.getElementById('sprintResult');
        const taskIdEl = document.getElementById('sprintTaskId');
        const taskNameEl = document.getElementById('sprintTaskName');
        const statusTextEl = document.getElementById('sprintTaskStatusText');
        const progressFillEl = document.getElementById('sprintProgressFill');
        const progressTextEl = document.getElementById('sprintProgressText');

        // éªŒè¯è¾“å…¥
        if (!sprintName) {
            showResult(resultEl, 'error', '<strong>é”™è¯¯:</strong> è¯·è¾“å…¥Sprintåç§°');
            return;
        }

        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.disabled = true;
        loadingEl.style.display = 'block';
        taskStatusEl.style.display = 'none';
        resultEl.style.display = 'none';

        try {
            // æäº¤å¼‚æ­¥ä»»åŠ¡
            const response = await taskManager.submitTask(
                `${API_BASE_URL}/sprints/${encodeURIComponent(sprintName)}/sync-bugs/async`
            );

            if (response.code === 0) {
                const taskId = response.data.task_id;

                // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯
                taskIdEl.textContent = taskId;
                taskNameEl.textContent = sprintName;
                statusTextEl.textContent = 'å·²æäº¤';
                progressFillEl.style.width = '0%';
                progressTextEl.textContent = '0%';
                taskStatusEl.style.display = 'block';
                loadingEl.style.display = 'none';

                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                taskManager.pollTaskStatus(
                    taskId,
                    (statusData) => {
                        // ä½¿ç”¨å®é™…è¿›åº¦å€¼æ›´æ–°è¿›åº¦æ¡
                        const progress = statusData.progress || 0;
                        progressFillEl.style.width = `${progress}%`;
                        progressTextEl.textContent = `${progress}%`;

                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        statusTextEl.textContent = statusData.status === 'completed' ? 'å·²å®Œæˆ' :
                                                 statusData.status === 'failed' ? 'å¤±è´¥' :
                                                 statusData.status === 'running' ? `è¿è¡Œä¸­ (${progress}%)` : 'å¤„ç†ä¸­';
                    },
                    (result) => {
                        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                        if (result.code === 0) {
                            showResult(resultEl, 'success', `
                                <strong>æˆåŠŸæ›´æ–°Sprint Bugs!</strong><br>
                                å¤„ç†æ€»æ•°: ${result.data.count || 0}<br>
                                æˆåŠŸæ•°é‡: ${result.data.success?.length || 0}<br>
                                å¤±è´¥æ•°é‡: ${result.data.error?.length || 0}
                            `);
                        } else {
                            showResult(resultEl, 'error', `<strong>æ›´æ–°å¤±è´¥:</strong> ${result.message}`);
                        }

                        // æ¢å¤æŒ‰é’®
                        btn.disabled = false;
                    }
                );
            } else {
                showResult(resultEl, 'error', `<strong>ä»»åŠ¡æäº¤å¤±è´¥:</strong> ${response.message}`);
                btn.disabled = false;
                loadingEl.style.display = 'none';
            }
        } catch (error) {
            showResult(resultEl, 'error', `<strong>è¯·æ±‚å¤±è´¥:</strong> ${error.message}`);
            btn.disabled = false;
            loadingEl.style.display = 'none';
        }
    });

    // è·å–NAS SMARTä¿¡æ¯æŒ‰é’®äº‹ä»¶
    document.getElementById('getSmartBtn').addEventListener('click', async function() {
        const btn = this;
        const nasIp = document.getElementById('nasIp').value.trim();
        const nasUser = document.getElementById('nasUser').value.trim();
        const nasPassword = document.getElementById('nasPassword').value;
        const loadingEl = document.getElementById('smartLoading');
        const resultEl = document.getElementById('smartResult');

        // éªŒè¯è¾“å…¥
        if (!nasIp) {
            showResult(resultEl, 'error', '<strong>é”™è¯¯:</strong> è¯·è¾“å…¥NAS IPåœ°å€');
            return;
        }

        if (!nasUser) {
            showResult(resultEl, 'error', '<strong>é”™è¯¯:</strong> è¯·è¾“å…¥ç”¨æˆ·å');
            return;
        }

        // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.disabled = true;
        loadingEl.style.display = 'block';
        resultEl.style.display = 'none';

        try {
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                nas_ip: nasIp,
                nas_user: nasUser
            };

            // å¦‚æœæä¾›äº†å¯†ç ï¼Œåˆ™æ·»åŠ åˆ°è¯·æ±‚æ•°æ®ä¸­
            if (nasPassword) {
                requestData.nas_password = nasPassword;
            }

            // å‘é€POSTè¯·æ±‚è·å–SMARTä¿¡æ¯
            const response = await fetch('/api/v1/device_info/fetch-smart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });

            const result = await response.json();

            if (result.code === 0) {
                showResult(resultEl, 'success', `<strong>æˆåŠŸè·å–SMARTä¿¡æ¯!</strong><br>è®°å½•ID: ${result.data.record_id}`);
            } else {
                showResult(resultEl, 'error', `<strong>è·å–å¤±è´¥:</strong> ${result.message}`);
            }
        } catch (error) {
            showResult(resultEl, 'error', `<strong>è¯·æ±‚å¤±è´¥:</strong> ${error.message}`);
        } finally {
            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            loadingEl.style.display = 'none';
        }
    });
    // Add this after the existing getSmartBtn event listener
    document.getElementById('viewSmartBtn').addEventListener('click', function() {
        // Navigate to the SMART monitor page
        window.location.href = '/smart-monitor';
    });


    // æ˜¾ç¤ºç»“æœå‡½æ•°
    function showResult(element, type, message) {
        element.innerHTML = message;
        element.className = `result-section result-${type}`;
        element.style.display = 'block';
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é£ä¹¦é¡¹ç›®ä¸PingCodeé›†æˆå·¥å…·å·²åŠ è½½');
    });
</script>
</body>
</html>
